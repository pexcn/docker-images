From 4d80336b5e8dc07688ba4b7e5a0a254ad77a7534 Mon Sep 17 00:00:00 2001
From: Mike Wang <mikewang000000@gmail.com>
Date: Sat, 15 Mar 2025 21:04:19 +0800
Subject: [PATCH] feat: Add --fake-http option

---
 README.md           |  5 +++++
 connection.cpp      | 34 ++++++++++++++++++++++++++++++++++
 doc/README.zh-cn.md |  5 +++++
 misc.cpp            | 10 ++++++++++
 4 files changed, 54 insertions(+)

diff --git a/README.md b/README.md
index 06b2a45..2bfdd8b 100755
--- a/README.md
+++ b/README.md
@@ -115,6 +115,7 @@ client options:
 other options:
     --conf-file           <string>        read options from a configuration file instead of command line.
                                           check example.conf in repo for format
+    --fake-http           <string>        enable http obfuscation and use given string as hostname.
     --fifo                <string>        use a fifo(named pipe) for sending commands to the running program,
                                           check readme.md in repository for supported commands.
     --log-level           <number>        0:never    1:fatal   2:error   3:warn
@@ -198,6 +199,10 @@ Use a fifo(named pipe) for sending commands to the running program. For example
 
 At client side,you can use `echo reconnect >fifo.file` to force client to reconnect.Currently no command has been implemented for server.
 
+### `--fake-http`
+
+During the handshake, the HTTP request header is sent first for obfuscation, with specified string as the hostname of the target.
+
 # Peformance Test
 #### Test method:
 iperf3 TCP via OpenVPN + udp2raw
diff --git a/connection.cpp b/connection.cpp
index b075491..0956a3b 100644
--- a/connection.cpp
+++ b/connection.cpp
@@ -15,6 +15,8 @@ const int disable_conn_clear = 0;  // a raw connection is called conn.
 
 conn_manager_t conn_manager;
 
+extern char fake_http_hostname[256];
+
 anti_replay_seq_t anti_replay_t::get_new_seq_for_send() {
     return anti_replay_seq++;
 }
@@ -364,8 +366,40 @@ int recv_bare(raw_info_t &raw_info, char *&data, int &len)  // recv function wit
     return reserved_parse_bare(data, len, data, len);
 }
 
+static int send_fake_http(raw_info_t &raw_info)
+{
+    static const char *user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
+                                    "AppleWebKit/537.36 (KHTML, like Gecko) "
+                                    "Chrome/120.0.0.0 Safari/537.36";
+    char data[1500];
+    bool psh_old = raw_info.send_info.psh;
+
+    snprintf(data, sizeof(data), 
+        "GET / HTTP/1.1\r\n"
+        "Host: %s\r\n"
+        "User-Agent: %s\r\n"
+        "Accept: */*\r\n"
+        "\r\n",
+        fake_http_hostname, user_agent
+    );
+
+    raw_info.send_info.psh = 1;
+    if (send_raw0(raw_info, data, strlen(data)) != 0) {
+        mylog(log_warn, "send fake http failed\n");
+        return -1;
+    }
+
+    usleep(32000);
+    raw_info.send_info.psh = psh_old;
+
+    return 0;
+}
+
 int send_handshake(raw_info_t &raw_info, my_id_t id1, my_id_t id2, my_id_t id3)  // a warp for send_bare for sending handshake(this is not tcp handshake) easily
 {
+    if (fake_http_hostname[0] && send_fake_http(raw_info) != 0)
+        return -1;
+
     packet_info_t &send_info = raw_info.send_info;
     packet_info_t &recv_info = raw_info.recv_info;
 
diff --git a/doc/README.zh-cn.md b/doc/README.zh-cn.md
index c303e7a..e78801e 100644
--- a/doc/README.zh-cn.md
+++ b/doc/README.zh-cn.md
@@ -128,6 +128,7 @@ client options:
 other options:
     --conf-file           <string>        read options from a configuration file instead of command line.
                                           check example.conf in repo for format
+    --fake-http           <string>        enable http obfuscation and use given string as hostname.
     --fifo                <string>        use a fifo(named pipe) for sending commands to the running program,
                                           check readme.md in repository for supported commands.
     --log-level           <number>        0:never    1:fatal   2:error   3:warn
@@ -233,6 +234,10 @@ server端也可以用`--lower-level auto` 来尝试自动获得参数，如果
 ./udp2raw_amd64 --conf-file server.conf
 ```
 
+### `--fake-http`
+
+握手时，首先发送 HTTP 请求头作为混淆，并使用指定字符串作为目标主机名。
+
 # 性能测试
 iperf3 的UDP模式有BUG，所以，这里用iperf3的tcp模式，配合Openvpn，测试udp2raw的性能。（iperf3 udp issue ,https://github.com/esnet/iperf/issues/296 ）
 
diff --git a/misc.cpp b/misc.cpp
index 737c9be..c38904f 100644
--- a/misc.cpp
+++ b/misc.cpp
@@ -90,6 +90,9 @@ int socket_buf_size = 1024 * 1024;
 // int force_socket_buf=0;
 
 // char lower_level_arg[1000];
+
+char fake_http_hostname[256] = "";
+
 #ifdef UDP2RAW_LINUX
 int process_lower_level_arg()  // handle --lower-level option
 {
@@ -158,6 +161,7 @@ void print_help() {
     printf("other options:\n");
     printf("    --conf-file           <string>        read options from a configuration file instead of command line.\n");
     printf("                                          check example.conf in repo for format\n");
+    printf("    --fake-http           <string>        enable http obfuscation and use given string as hostname.\n");
     printf("    --fifo                <string>        use a fifo(named pipe) for sending commands to the running program,\n");
     printf("                                          check readme.md in repository for supported commands.\n");
     printf("    --log-level           <number>        0:never    1:fatal   2:error   3:warn \n");
@@ -296,6 +300,7 @@ void process_arg(int argc, char *argv[])  // process all options
             {"no-pcap-mutex", no_argument, 0, 1},
 #endif
             {"fix-gro", no_argument, 0, 1},
+            {"fake-http", required_argument, 0, 1},
             {NULL, 0, 0, 0}};
 
     process_log_level(argc, argv);
@@ -675,6 +680,11 @@ void process_arg(int argc, char *argv[])  // process all options
                     use_tcp_dummy_socket = 1;
                     mylog(log_info, "--easy-tcp enabled, now a dummy tcp socket will be created for handshake and block rst\n");
                 } else if (strcmp(long_options[option_index].name, "fix-gro") == 0) {
+                    mylog(log_info, "--fix-gro enabled\n");
+                    g_fix_gro = 1;
+                } else if (strcmp(long_options[option_index].name, "fake-http") == 0) {
+                    sscanf(optarg, "%255s", fake_http_hostname);
+
                     mylog(log_info, "--fix-gro enabled\n");
                     g_fix_gro = 1;
                 } else {
-- 
2.52.0

